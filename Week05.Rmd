---
title: "Week05"
author: "CXiao"
date: "5/1/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load library  
```{r message = F, warning = F}
library(tidyverse)
library(Hmisc)
library(maps)
```

### Read in data  
```{r message = F, warning = F}
dfASC <- read_csv("data/acs2015_county_data.csv")
```

### County Map data
```{r}
Upper1  <- function(x){
  substr(x, 1, 1) <- toupper(substr(x, 1, 1))
  x
}

cnty <- map_data("county")%>%
  as_tibble()%>%
  rename(State = region, County = subregion) %>%
  mutate(County = str_replace(County, "Dona Ana", "Do√±a Ana")) 

dfASC <- dfASC%>%
  select(CensusId:County, MeanCommute)


head(cnty)
```

### Join Map and ASC
```{r}
# cnty has 48 states and DC
# ASC has all 50 States, DC and PR
cntyASC <- left_join(cnty, dfASC, by = c("State", "County"))
```

### Find out missing counties
```{r}
cntyMiss <- cntyASC%>%
  filter(is.na(MeanCommute))%>%
  group_by(State, County)%>%
  summarise(Missing = 1)

cntyMiss %>% as.data.frame()
# https://en.wikipedia.org/wiki/De_Kalb,_Missouri
# https://en.wikipedia.org/wiki/DeKalb_County,_Alabama

```

### Number of counties in each state   
```{r}
# Number of counties in each state
numMap <- cnty %>%
  distinct(State, County) %>%
  group_by(State) %>%
  summarise(count = n())

numASC <- dfASC %>%
  group_by(State) %>%
  summarise(count = n())  

numCnty <- inner_join(numMap, numASC, by = "State") %>%
  mutate(diff = count.x - count.y)

numMap1 <- cnty %>%
  distinct(State, County) %>%
  filter(State == "virginia")

numASC1 <- dfASC %>%
  group_by(State) %>%
  filter(State == "virginia")
```

## plot  
### Plot counties
```{r message = F, warning = F, fig.width = 10}
p <- ggplot(cnty, aes(long, lat, group = group)) + 
  geom_polygon(data = cntyASC, aes(fill = MeanCommute), 
 #              show.legend = FALSE, 
               colour = "grey") + 
  coord_quickmap()+
  scale_fill_distiller(palette = "Spectral")+
  theme_void()+
  labs(title = "Commute Time (min)",
       caption = "Cource: US Census Demogrpahic Data 2015")
p
```



### plotly  
```{r message = F, warning = F, fig.width = 10}
library(plotly)
#ggplotly(p)
```

## `choroplethr` framework  
```{r message = F, warning = F}
# https://bookdown.org/rdpeng/RProgDA/mapping.html#mapping-us-counties-and-states
# https://github.com/trulia/choroplethr
library(choroplethr)
library(choroplethrMaps)
data(df_pop_county)
```


### Commute Time 
```{r}
# https://twitter.com/nlj/status/991149834085289984
mean_commute <- dfASC %>%
  select(CensusId, MeanCommute) %>%
  rename(region = CensusId, value = MeanCommute)

choro               <- CountyChoropleth$new(mean_commute)
choro$title         <- "Mean Commute Times by County"
choro$ggplot_scale  <- scale_fill_brewer(name = "Time", palette = 2, drop = F)
choro$render()
```

